<?xml version="1.0" encoding="utf-8" ?>
<?xaml-comp compile="true" ?>
<ContentPage
    x:Class="DietMVP.Pages.Doctor.ReportDetailPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    BackgroundColor="{StaticResource Color.Background}"
    Title="Rapor DetayÄ±"
    Padding="{OnPlatform iOS='16,56,16,12', Android='16,32,16,12'}">

    <ContentPage.Resources>
        <!-- YumuÅŸak kart -->
        <Style x:Key="SoftCard" TargetType="Border">
            <Setter Property="StrokeShape">
                <Setter.Value>
                    <RoundRectangle CornerRadius="18"/>
                </Setter.Value>
            </Setter>
            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#FFFFFF, Dark=#111827}"/>
            <Setter Property="Padding" Value="14"/>
            <Setter Property="Margin" Value="0,8"/>
            <Setter Property="Shadow">
                <Shadow Brush="#000" Opacity="0.06" Radius="12" />
            </Setter>
        </Style>

        <!-- Rozet -->
        <Style x:Key="Badge" TargetType="Frame">
            <Setter Property="Padding" Value="6,2"/>
            <Setter Property="CornerRadius" Value="10"/>
            <Setter Property="HasShadow" Value="False"/>
            <Setter Property="BackgroundColor" Value="#E5E7EB"/>
        </Style>

        <!-- KÃ¼Ã§Ã¼k Ã§ip -->
        <Style x:Key="Chip" TargetType="Button">
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="CornerRadius" Value="14"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#F3F4F6, Dark=#1F2937}"/>
            <Setter Property="TextColor" Value="{AppThemeBinding Light=#111827, Dark=#E5E7EB}"/>
            <Setter Property="BorderColor" Value="{AppThemeBinding Light=#E5E7EB, Dark=#374151}"/>
            <Setter Property="Margin" Value="4"/>
        </Style>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*" RowSpacing="12">

        <!-- HERO / Gradient baÅŸlÄ±k -->
        <Border>
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="18"/>
            </Border.StrokeShape>
            <Border.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                    <GradientStop Color="#6D28D9" Offset="0"/>
                    <GradientStop Color="#4F46E5" Offset="1"/>
                </LinearGradientBrush>
            </Border.Background>

            <Grid Padding="16" ColumnDefinitions="Auto,*" ColumnSpacing="12">
                <Border WidthRequest="44" HeightRequest="44" StrokeThickness="0"
                        BackgroundColor="#33111827" StrokeShape="RoundRectangle 22"
                        VerticalOptions="Center">
                    <Label Text="ðŸ“ˆ" FontSize="22" HorizontalTextAlignment="Center" VerticalTextAlignment="Center"/>
                </Border>

                <VerticalStackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center">
                    <!-- AynÄ± isim kalsÄ±n: Header -->
                    <Label x:Name="Header" Text="Rapor DetayÄ±" TextColor="White" FontSize="22" FontAttributes="Bold"/>
                    <Label x:Name="DateRangeText" TextColor="#E5E7EB" FontSize="13"/>
                </VerticalStackLayout>
            </Grid>
        </Border>

        <ScrollView Grid.Row="1">
            <VerticalStackLayout Spacing="12">

                <!-- FÄ°LTRE KARTI -->
                <Border Style="{StaticResource SoftCard}">
                    <VerticalStackLayout Spacing="10">

                        <Grid ColumnDefinitions="*,16,*" ColumnSpacing="0">
                            <VerticalStackLayout>
                                <Label Text="BaÅŸlangÄ±Ã§" FontSize="12" TextColor="{StaticResource Color.Muted}"/>
                                <DatePicker x:Name="FromPicker" />
                            </VerticalStackLayout>

                            <BoxView Grid.Column="1" WidthRequest="16" Opacity="0"/>

                            <VerticalStackLayout Grid.Column="2">
                                <Label Text="BitiÅŸ" FontSize="12" TextColor="{StaticResource Color.Muted}"/>
                                <DatePicker x:Name="ToPicker" />
                            </VerticalStackLayout>
                        </Grid>

                        <!-- HÄ±zlÄ± aralÄ±k Ã§ipleri -->
                        <FlexLayout Wrap="Wrap" AlignItems="Center" JustifyContent="Start">
                            <Button Style="{StaticResource Chip}" Text="Son 7 gÃ¼n"  Clicked="OnQuickRange" CommandParameter="7"/>
                            <Button Style="{StaticResource Chip}" Text="Son 14 gÃ¼n" Clicked="OnQuickRange" CommandParameter="14"/>
                            <Button Style="{StaticResource Chip}" Text="Bu Ay"     Clicked="OnQuickRange" CommandParameter="month"/>
                            <Button Style="{StaticResource Chip}" Text="BugÃ¼n"     Clicked="OnQuickRange" CommandParameter="today"/>
                            <Button Style="{StaticResource Chip}" Text="Uygula"    Clicked="OnApplyFilter"/>
                        </FlexLayout>

                    </VerticalStackLayout>
                </Border>

                <!-- Ã–ZET -->
                <Border Style="{StaticResource SoftCard}">
                    <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto" RowSpacing="8">
                        <Label Text="GÃ¼n" TextColor="{StaticResource Color.Muted}"/>
                        <Label x:Name="SumDays" Grid.Column="1" FontFamily="{StaticResource Font.SansBold}"/>

                        <Grid Grid.Row="1" ColumnDefinitions="*,Auto,Auto" ColumnSpacing="12">
                            <Label>
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span Text="Ã–ÄŸÃ¼n: " TextColor="{StaticResource Color.Muted}"/>
                                        <Span x:Name="SumMealPlanned"/>
                                        <Span Text=" plan â€¢ " TextColor="{StaticResource Color.Muted}"/>
                                        <Span x:Name="SumMealDone"/>
                                        <Span Text=" yapÄ±ldÄ± â€¢ " TextColor="{StaticResource Color.Muted}"/>
                                        <Span x:Name="SumMealSkipped"/>
                                        <Span Text=" kaÃ§Ä±rÄ±ldÄ±" TextColor="{StaticResource Color.Muted}"/>
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>
                            <Frame Grid.Column="1" Style="{StaticResource Badge}" BackgroundColor="#2563EB">
                                <Label x:Name="SumAdh" TextColor="White" FontAttributes="Bold" />
                            </Frame>
                            <Label Grid.Column="2" x:Name="SumAdhDesc" TextColor="{StaticResource Color.Muted}" />
                        </Grid>

                        <Grid Grid.Row="2" ColumnDefinitions="*,Auto" ColumnSpacing="12">
                            <Label>
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span Text="Su: " TextColor="{StaticResource Color.Muted}"/>
                                        <Span x:Name="SumWaterLiters"/>
                                        <Span Text=" L toplam â€¢ " TextColor="{StaticResource Color.Muted}"/>
                                        <Span x:Name="AvgWaterLiters"/>
                                        <Span Text=" L/gÃ¼n ort." TextColor="{StaticResource Color.Muted}"/>
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>
                            <Frame Grid.Column="1" Style="{StaticResource Badge}">
                                <Label x:Name="SumRange" />
                            </Frame>
                        </Grid>
                    </Grid>
                </Border>

                <Label Text="GÃ¼nler ve Ã–ÄŸÃ¼nler" Style="{StaticResource Text.H2}"/>

                <!-- GÃœNLER -->
                <CollectionView x:Name="DaysList" SelectionMode="None">
                    <CollectionView.EmptyView>
                        <Label Text="KayÄ±t yok." HorizontalOptions="Center" TextColor="{StaticResource Color.Muted}" />
                    </CollectionView.EmptyView>
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Border Style="{StaticResource SoftCard}">
                                <VerticalStackLayout Spacing="10">

                                    <Grid ColumnDefinitions="*,Auto,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="12">
                                        <Label Text="{Binding DateText}" FontAttributes="Bold" />
                                        <Frame Grid.Column="1" Style="{StaticResource Badge}" BackgroundColor="{Binding BadgeColor}">
                                            <Label Text="{Binding AdherenceLabel}" TextColor="White" FontAttributes="Bold"/>
                                        </Frame>
                                        <Label Grid.Column="2" Text="{Binding WaterLitersText}" TextColor="{StaticResource Color.Muted}" />

                                        <Grid Grid.Row="1" ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                            <Label>
                                                <Label.FormattedText>
                                                    <FormattedString>
                                                        <Span Text="Ã–ÄŸÃ¼n: " TextColor="{StaticResource Color.Muted}"/>
                                                        <Span Text="{Binding Done}"/>
                                                        <Span Text="/" TextColor="{StaticResource Color.Muted}"/>
                                                        <Span Text="{Binding Planned}"/>
                                                        <Span Text=" â€¢ " TextColor="{StaticResource Color.Muted}"/>
                                                        <Span Text="{Binding Skipped}"/>
                                                        <Span Text=" kaÃ§Ä±rÄ±ldÄ±" TextColor="{StaticResource Color.Muted}"/>
                                                    </FormattedString>
                                                </Label.FormattedText>
                                            </Label>
                                            <Label Grid.Column="1" Text="{Binding StatusText}" TextColor="{StaticResource Color.Muted}" />
                                        </Grid>
                                    </Grid>

                                    <ProgressBar Progress="{Binding Adherence}" HeightRequest="6"
                                                 BackgroundColor="{AppThemeBinding Light=#EEF2FF, Dark=#1F2937}"
                                                 ProgressColor="#6D28D9" />

                                    <!-- Ã–ÄžÃœN DETAYLARI -->
                                    <VerticalStackLayout Spacing="8" BindableLayout.ItemsSource="{Binding Meals}">
                                        <BindableLayout.ItemTemplate>
                                            <DataTemplate>
                                                <Border Style="{StaticResource SoftCard}">
                                                    <VerticalStackLayout Spacing="8">

                                                        <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="12">
                                                            <Label Text="{Binding MealName}" FontAttributes="Bold" />
                                                            <Frame Grid.Column="1" Style="{StaticResource Badge}" BackgroundColor="{Binding StatusBadgeColor}">
                                                                <Label Text="{Binding StatusText}" TextColor="White" FontAttributes="Bold"/>
                                                            </Frame>
                                                            <Label Grid.Column="2" Text="{Binding CompletedAtText}" TextColor="{StaticResource Color.Muted}" />
                                                        </Grid>

                                                        <Label Text="{Binding Note}" IsVisible="{Binding HasNote}" TextColor="{StaticResource Color.Muted}" />

                                                        <ScrollView Orientation="Horizontal" IsVisible="{Binding HasPhotos}" HeightRequest="96">
                                                            <HorizontalStackLayout Spacing="8" BindableLayout.ItemsSource="{Binding Photos}">
                                                                <BindableLayout.ItemTemplate>
                                                                    <DataTemplate>
                                                                        <Border StrokeThickness="0" StrokeShape="RoundRectangle 10" WidthRequest="96" HeightRequest="96">
                                                                            <Image Source="{Binding .}" Aspect="AspectFill" WidthRequest="96" HeightRequest="96"/>
                                                                        </Border>
                                                                    </DataTemplate>
                                                                </BindableLayout.ItemTemplate>
                                                            </HorizontalStackLayout>
                                                        </ScrollView>

                                                    </VerticalStackLayout>
                                                </Border>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </VerticalStackLayout>

                                </VerticalStackLayout>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <BoxView HeightRequest="24" Opacity="0"/>
            </VerticalStackLayout>
        </ScrollView>

        <!-- YÃœKLENÄ°YOR OVERLAY (ortalanmÄ±ÅŸ, animasyonlu kart) -->
        <Grid x:Name="BusyOverlay" Grid.RowSpan="2" IsVisible="False" InputTransparent="False"
              BackgroundColor="{AppThemeBinding Light=#00000066, Dark=#00000099}">
            <Border x:Name="BusyCard" Padding="16" StrokeThickness="0" Opacity="0" Scale="0.96"
                    BackgroundColor="{AppThemeBinding Light=#FFFFFFFF, Dark=#172033F0}"
                    HorizontalOptions="Center" VerticalOptions="Center">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="18"/>
                </Border.StrokeShape>
                <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                    <ActivityIndicator IsRunning="True"/>
                    <Label x:Name="BusyText" Text="YÃ¼kleniyor..." 
                           TextColor="{AppThemeBinding Light=#111827, Dark=#E5E7EB}" 
                           FontAttributes="Bold"/>
                </HorizontalStackLayout>
            </Border>
        </Grid>

    </Grid>
</ContentPage>
