<?xml version="1.0" encoding="utf-8" ?>
<?xaml-comp compile="true" ?>
<ContentPage
    x:Class="DietMVP.Pages.Patient.HomePage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    Padding="{OnPlatform iOS='16,56,16,12', Android='16,32,16,12'}"
    BackgroundColor="{AppThemeBinding Light=#F7F8FA, Dark=#0B1220}"
    Title="Bugün">

    <ContentPage.Resources>
        <!-- Kart -->
        <Style x:Key="Card" TargetType="Border">
            <Setter Property="StrokeShape">
                <RoundRectangle CornerRadius="18"/>
            </Setter>
            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#FFFFFF, Dark=#111827}"/>
            <Setter Property="StrokeThickness" Value="0"/>
            <Setter Property="Padding" Value="16"/>
            <Setter Property="Shadow">
                <Shadow Brush="#000000" Opacity="0.08" Radius="12" />
            </Setter>
            <Setter Property="Margin" Value="0,8"/>
        </Style>

        <!-- Başlık stilleri -->
        <Style x:Key="H1" TargetType="Label">
            <Setter Property="FontSize" Value="22"/>
            <Setter Property="FontAttributes" Value="Bold"/>
            <Setter Property="TextColor" Value="{AppThemeBinding Light=#111827, Dark=#E5E7EB}"/>
        </Style>
        <Style x:Key="H2" TargetType="Label">
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="FontAttributes" Value="Bold"/>
            <Setter Property="TextColor" Value="{AppThemeBinding Light=#111827, Dark=#E5E7EB}"/>
        </Style>
        <Style x:Key="Muted" TargetType="Label">
            <Setter Property="TextColor" Value="{AppThemeBinding Light=#6B7280, Dark=#94A3B8}"/>
        </Style>

        <!-- Küçük ikincil buton -->
        <Style x:Key="ChipButton" TargetType="Button">
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="HeightRequest" Value="40"/>
            <Setter Property="FontAttributes" Value="Bold"/>
            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#EEF2FF, Dark=#1F2937}"/>
            <Setter Property="TextColor" Value="{AppThemeBinding Light=#4338CA, Dark=#C7D2FE}"/>
        </Style>

        <!-- Durum rozet renkleri -->
        <Color x:Key="Badge.WaitLight">#F59E0B</Color>
        <Color x:Key="Badge.WaitDark">#FBBF24</Color>
        <Color x:Key="Badge.GoLight">#3B82F6</Color>
        <Color x:Key="Badge.GoDark">#60A5FA</Color>
        <Color x:Key="Badge.DoneLight">#10B981</Color>
        <Color x:Key="Badge.DoneDark">#34D399</Color>
    </ContentPage.Resources>

    <Grid>

        <!-- Pull-to-refresh + liste -->
        <RefreshView x:Name="RefreshHost" Refreshing="OnRefresh">
            <ScrollView>
                <VerticalStackLayout Spacing="14">

                    <!-- Gradient karşılama -->
                    <Border Padding="16" StrokeThickness="0" Margin="0,0,0,8">
                        <Border.Background>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                <GradientStop Color="#6D28D9" Offset="0"/>
                                <GradientStop Color="#4F46E5" Offset="1"/>
                            </LinearGradientBrush>
                        </Border.Background>
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="20"/>
                        </Border.StrokeShape>

                        <Grid ColumnDefinitions="Auto,*" ColumnSpacing="16">
                            <!-- Su ring -->
                            <GraphicsView x:Name="WaterRing" WidthRequest="84" HeightRequest="84"
                                          VerticalOptions="Center" HorizontalOptions="Start" />
                            <VerticalStackLayout Grid.Column="1" Spacing="4" VerticalOptions="Center">
                                <Label x:Name="Header" TextColor="White" FontAttributes="Bold" FontSize="18"/>
                                <Label x:Name="LblToday" TextColor="#E0E7FF"/>
                                <Label x:Name="LblWaterSummary" TextColor="#E0E7FF" />
                            </VerticalStackLayout>
                        </Grid>
                    </Border>

                    <!-- Su kontrol kartı -->
                    <Border Style="{StaticResource Card}">
                        <VerticalStackLayout Spacing="10">
                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                <Image Source="ic_cup.png" HeightRequest="20" VerticalOptions="Center"/>
                                <Label Grid.Column="1" Text="Su Takibi" Style="{StaticResource H2}"/>
                                <Label Grid.Column="2" x:Name="LblCupInfo" Style="{StaticResource Muted}" VerticalTextAlignment="Center"/>
                            </Grid>

                            <!-- DÜZELTİLDİ: 4 kolon -->
                            <Grid ColumnDefinitions="Auto,Auto,*,Auto" ColumnSpacing="8">
                                <Button Text="−" Clicked="OnCupMinus" WidthRequest="48" Style="{StaticResource ChipButton}"/>
                                <Button Grid.Column="1" Text="+" Clicked="OnCupPlus" WidthRequest="48" Style="{StaticResource ChipButton}"/>
                                <ProgressBar Grid.Column="2" x:Name="WaterProgress" HeightRequest="10"
                   BackgroundColor="{AppThemeBinding Light=#EEF2FF, Dark=#1F2937}"
                   ProgressColor="#6D28D9" VerticalOptions="Center"/>
                                <Button Grid.Column="3" Text="Kaydet" Clicked="OnSaveWater" Style="{StaticResource ChipButton}"/>
                            </Grid>
                        </VerticalStackLayout>
                    </Border>

                    <!-- Öğünler -->
                    <Label Text="Öğünler" Style="{StaticResource H2}" />

                    <CollectionView x:Name="MealsList" SelectionMode="None">
                        <CollectionView.EmptyView>
                            <Label Text="Bugün için plan yok." HorizontalOptions="Center" Style="{StaticResource Muted}" />
                        </CollectionView.EmptyView>

                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid ColumnDefinitions="4,*">
                                    <!-- sol şerit -->
                                    <BoxView WidthRequest="4" BackgroundColor="{Binding StripeColor}" />
                                    <!-- kart -->
                                    <Border Grid.Column="1" Style="{StaticResource Card}" Padding="14" Margin="8,6,0,6">
                                        <VerticalStackLayout Spacing="10">

                                            <!-- ÜST SATIR: emoji + başlık/altbaşlık + saat -->
                                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">

                                                <VerticalStackLayout Spacing="2" VerticalOptions="Center">
                                                    <Label Text="{Binding Title}" FontAttributes="Bold" TextColor="{AppThemeBinding Light=#111827, Dark=#E5E7EB}" />
                                                    <!-- YENİ: öğün özeti -->
                                                    <Label Text="{Binding Subtitle}" Style="{StaticResource Muted}" FontSize="12"/>
                                                </VerticalStackLayout>

                                                <!-- saat: ÖÖ/ÖS -->
                                                <Label Grid.Column="2" Text="{Binding TimeRange}" Style="{StaticResource Muted}"
                     FontAttributes="Bold" VerticalTextAlignment="Center"/>
                                            </Grid>

                                            <!-- rozet/kalori satırı -->
                                            <HorizontalStackLayout Spacing="8">
                                                <Border Padding="8,4" StrokeThickness="0" StrokeShape="RoundRectangle 10"
                      BackgroundColor="{Binding StatusBadgeColor}">
                                                    <Label Text="{Binding StatusText}" TextColor="White" FontAttributes="Bold"/>
                                                </Border>

                                                <!-- YENİ: toplam kalori varsa chip -->
                                                <Border IsVisible="{Binding HasKcal}" Padding="8,4" StrokeThickness="0"
                      BackgroundColor="{AppThemeBinding Light=#EEF2FF, Dark=#1F2937}"
                      StrokeShape="RoundRectangle 10">
                                                    <Label Text="{Binding KcalText}" TextColor="{AppThemeBinding Light=#4338CA, Dark=#C7D2FE}" FontAttributes="Bold"/>
                                                </Border>
                                            </HorizontalStackLayout>

                                            <!-- detay listesi (istersen bırak, çok uzun kaçarsa kaldırabilirsin) -->
                                            <VerticalStackLayout Spacing="4" BindableLayout.ItemsSource="{Binding Items}">
                                                <BindableLayout.ItemTemplate>
                                                    <DataTemplate>
                                                        <HorizontalStackLayout Spacing="6">
                                                            <BoxView WidthRequest="6" HeightRequest="6" CornerRadius="3" Color="#9CA3AF" VerticalOptions="Center"/>
                                                            <Label Text="{Binding .}" Style="{StaticResource Muted}" />
                                                        </HorizontalStackLayout>
                                                    </DataTemplate>
                                                </BindableLayout.ItemTemplate>
                                            </VerticalStackLayout>

                                            <!-- foto -->
                                            <Border Padding="0" StrokeThickness="0" IsVisible="{Binding HasPhoto}" StrokeShape="RoundRectangle 10">
                                                <Image HeightRequest="180" Aspect="AspectFill" Source="{Binding PhotoUrl}" />
                                            </Border>

                                            <Label Text="{Binding LastLogText}" Style="{StaticResource Muted}" FontSize="12" IsVisible="{Binding HasLastLog}" />

                                            <Button Text="Öğün Gir" Clicked="OnLogMeal" CommandParameter="{Binding .}"
                    IsVisible="{Binding ShowAction}" BackgroundColor="#6D28D9"
                    TextColor="White" CornerRadius="14" HeightRequest="48"/>
                                        </VerticalStackLayout>
                                    </Border>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>


                    <Label x:Name="Msg" IsVisible="False" TextColor="#DC2626" />

                    <BoxView HeightRequest="24" Opacity="0"/>
                </VerticalStackLayout>
            </ScrollView>
        </RefreshView>

        <!-- ŞIK mini-busy (alt sheet gibi) -->
        <Grid x:Name="BusyOverlay" IsVisible="False" InputTransparent="False">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer />
                <!-- arkaya tıklamayı bloke eder -->
            </Grid.GestureRecognizers>

            <Grid RowDefinitions="*,Auto,40">
                <Border Grid.Row="1" BackgroundColor="{AppThemeBinding Light=#FFFFFFFF, Dark=#172033F0}"
                        StrokeThickness="0" Padding="14" Margin="16"
                        TranslationY="40" Opacity="0"
                        x:Name="BusyCard">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="18"/>
                    </Border.StrokeShape>
                    <HorizontalStackLayout Spacing="12" VerticalOptions="Center">
                        <ActivityIndicator IsRunning="True"/>
                        <Label x:Name="BusyText" TextColor="{AppThemeBinding Light=#111827, Dark=#E5E7EB}" FontAttributes="Bold"/>
                    </HorizontalStackLayout>
                </Border>
            </Grid>
        </Grid>

        <!-- Toast aynı kalsın -->
        <Grid x:Name="ToastHost" Padding="16" IsVisible="False" InputTransparent="True">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="32" />
            </Grid.RowDefinitions>
            <Border Grid.Row="1" StrokeThickness="0" Padding="12"
                    BackgroundColor="#CC111827" HorizontalOptions="Center"
                    StrokeShape="RoundRectangle 14">
                <Label x:Name="ToastText" TextColor="White"/>
            </Border>
        </Grid>
    </Grid>
</ContentPage>
